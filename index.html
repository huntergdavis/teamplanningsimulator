<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TPS Reports - Excluding Quarter/Year from Ramp-Up</title>

  <!-- React & Babel from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <style>
    body {
      margin: 0; 
      padding: 0;
      font-family: sans-serif;
      color: #333;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      overflow: hidden;
    }
    .left-panel {
      padding: 1rem;
      background: #f3f4f6;
      overflow-y: auto;
    }
    .list-item {
      background: #4299e1;
      color: #fff;
      margin: 0.4rem 0;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s;
    }
    .list-item.year {
      background: #2c5282;
    }
    .list-item.quarter {
      background: #2b6cb0;
    }
    .list-item.sprint {
      background: #4299e1;
    }
    .assignments {
      margin-left: 1rem;
      display: flex;
      flex-wrap: wrap;
    }
    /* If isRamping => we show a little star */
    .assignments .ramp {
      color: #d53f8c;
      font-weight: bold;
      margin-left: 3px;
    }

    .right-panel {
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .roster {
      padding: 1rem;
      background: #fff;
      flex: 0 0 auto;
      border-bottom: 2px solid #ddd;
    }
    .roster-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .roster-header button {
      padding: 0.4rem 0.8rem;
      background: #3182ce;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .roster-items {
      margin-top: 1rem;
    }
    .roster-item {
      background: #edf2f7;
      margin: 0.25rem 0;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      transition: background 0.2s;
    }
    .roster-item:hover {
      background: #e2e8f0;
    }
    .report-section {
      padding: 1rem;
      flex: 1 1 auto;
      overflow-y: auto;
    }
    .report {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #aaa;
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

const YEAR_SPRINTS = 26; // cost factor => overhead/26
// role.pointsPerSprint => points for a full sprint
// if isRamping => half

const lineItems = [
  { id: 'year-2025', type: 'year',    name: '2025', roles: [], events: [] },
  { id: 'q1',        type: 'quarter', name: 'Q1',   roles: [], events: [] },
  { id: 'q1s1', type: 'sprint', name: 'Q1S1', roles: [], events: [] },
  { id: 'q1s2', type: 'sprint', name: 'Q1S2', roles: [], events: [] },
  { id: 'q1s3', type: 'sprint', name: 'Q1S3', roles: [], events: [] },
  { id: 'q1s4', type: 'sprint', name: 'Q1S4', roles: [], events: [] },
  { id: 'q1s5', type: 'sprint', name: 'Q1S5', roles: [], events: [] },
  { id: 'q1s6', type: 'sprint', name: 'Q1S6', roles: [], events: [] },

  { id: 'q2',   type: 'quarter', name: 'Q2', roles: [], events: [] },
  { id: 'q2s1', type: 'sprint',  name: 'Q2S1', roles: [], events: [] },
  { id: 'q2s2', type: 'sprint',  name: 'Q2S2', roles: [], events: [] },
  { id: 'q2s3', type: 'sprint',  name: 'Q2S3', roles: [], events: [] },
  { id: 'q2s4', type: 'sprint',  name: 'Q2S4', roles: [], events: [] },
  { id: 'q2s5', type: 'sprint',  name: 'Q2S5', roles: [], events: [] },
  { id: 'q2s6', type: 'sprint',  name: 'Q2S6', roles: [], events: [] },

  { id: 'q3',   type: 'quarter', name: 'Q3', roles: [], events: [] },
  { id: 'q3s1', type: 'sprint',  name: 'Q3S1', roles: [], events: [] },
  { id: 'q3s2', type: 'sprint',  name: 'Q3S2', roles: [], events: [] },
  { id: 'q3s3', type: 'sprint',  name: 'Q3S3', roles: [], events: [] },
  { id: 'q3s4', type: 'sprint',  name: 'Q3S4', roles: [], events: [] },
  { id: 'q3s5', type: 'sprint',  name: 'Q3S5', roles: [], events: [] },
  { id: 'q3s6', type: 'sprint',  name: 'Q3S6', roles: [], events: [] },

  { id: 'q4',   type: 'quarter', name: 'Q4', roles: [], events: [] },
  { id: 'q4s1', type: 'sprint',  name: 'Q4S1', roles: [], events: [] },
  { id: 'q4s2', type: 'sprint',  name: 'Q4S2', roles: [], events: [] },
  { id: 'q4s3', type: 'sprint',  name: 'Q4S3', roles: [], events: [] },
  { id: 'q4s4', type: 'sprint',  name: 'Q4S4', roles: [], events: [] },
  { id: 'q4s5', type: 'sprint',  name: 'Q4S5', roles: [], events: [] },
  { id: 'q4s6', type: 'sprint',  name: 'Q4S6', roles: [], events: [] },
];

function getSprintIndices(itemIndex) {
  const item=lineItems[itemIndex];
  if (item.type==='year') {
    // gather sprints => 2..28
    return Array.from({length:27}, (_,i)=> i+2);
  } else if (item.type==='quarter') {
    return gatherQuarterSprints(itemIndex);
  } else {
    return [itemIndex];
  }
}
function gatherQuarterSprints(qIndex) {
  let out=[];
  let i=qIndex+1;
  while (i<lineItems.length && lineItems[i].type==='sprint') {
    out.push(i);
    i++;
  }
  return out;
}

function TPSReportsApp(){
  const [items, setItems]=React.useState(lineItems);
  const [roles, setRoles]=React.useState([]);
  const [events, setEvents]=React.useState([]);
  const [reportTargetId, setReportTargetId]=React.useState(null);

  function handleAddNewItem(){
    const kind=prompt('Add "role" or "event"?');
    if (!kind) return;
    if (kind.toLowerCase()==='role') {
      const name= prompt('Role name?');
      const fte= prompt('Is this FTE? (yes/no)');
      const salStr= prompt('Yearly Salary?');
      const ptsStr= prompt('Points delivered per sprint?');
      const spec= prompt('Specialty? e.g. "UI"');
      const rampStr= prompt('How many sprints to ramp up? (0..6)?');

      let isFte=(fte?.toLowerCase()==='yes');
      let cLen=null;
      if (!isFte){
        const cStr=prompt('How many total sprints for this contract?');
        if (cStr){
          const cNum= parseInt(cStr,10);
          if (!isNaN(cNum)&& cNum>0) cLen=cNum;
        }
      }

      const newRole={
        id: 'role-'+Date.now(),
        name: name|| 'Untitled Role',
        fte: isFte,
        overheadMultiplier: isFte?1.17:1,
        salary: Number(salStr)||0,
        pointsPerSprint: Number(ptsStr)||0,
        specialty: spec|| 'generalist',
        rampUpSprints: parseInt(rampStr,10)||0,
        contractSprints: cLen, // null => unlimited
      };
      setRoles(prev=> [...prev,newRole]);
    } else if (kind.toLowerCase()==='event') {
      const name= prompt('Event name?');
      const impact= prompt('Impact to shift points? (pos/neg)?');
      const rep= prompt('Repeat forever? (yes/no)');
      const newEvent={
        id: 'event-'+Date.now(),
        name: name||'Untitled Event',
        impactPoints: Number(impact)||0,
        repeatForever: (rep?.toLowerCase()==='yes'),
      };
      setEvents(prev=>[...prev,newEvent]);
    } else {
      alert('Invalid type.');
    }
  }

  /**
   * Add role from chosen item forward, counting only real sprints for contract usage and ramp usage.
   * If lineItem.type === 'sprint', we might increment usageSoFar.
   * If it's year/quarter => no ramp-up increment.
   */
  function handleRoleClick(role){
    const qtyStr= prompt(`How many of "${role.name}"?`, '1');
    if (!qtyStr) return;
    const qty= parseInt(qtyStr,10);
    if (isNaN(qty)||qty<=0) { alert('Invalid #'); return; }

    const tgt= prompt('Which line item to start on? (e.g. "q3s4")');
    if (!tgt) return;
    const startIndex= items.findIndex(x=> x.id=== tgt);
    if (startIndex<0){
      alert('No such line item.');
      return;
    }

    const newArr=[...items];
    for (let c=0; c<qty; c++){
      let usageSoFar=0; 
      let maxS= role.fte? Infinity: (role.contractSprints||0);

      for (let i=startIndex; i<newArr.length; i++){
        const li=newArr[i];
        // Only add to year/quarter/sprint, skip everything else
        if (li.type!=='sprint' && li.type!=='year' && li.type!=='quarter') continue;

        // If it's a contract, we only want to actually "use up" sprints if it's a real sprint
        // Also ramp-up only applies if it's a real sprint
        let isRamping=false;
        if (li.type==='sprint') {
          // contract => if usageSoFar >= maxS => stop
          if (!role.fte && usageSoFar>= maxS) break;

          // ramp-up => if usageSoFar < role.rampUpSprints => half
          isRamping= (usageSoFar< role.rampUpSprints);
          usageSoFar++;
        } 
        // If it's year/quarter => we do NOT increment usageSoFar, no ramp.

        // add to this line item
        const oldRoles=[...li.roles];
        oldRoles.push({
          roleId: role.id,
          isRamping,
        });
        newArr[i]={ ...li, roles: oldRoles };
      }
    }

    setItems(newArr);
  }

  function handleEventClick(ev){
    const qtyStr= prompt(`How many of "${ev.name}"?`,'1');
    if (!qtyStr) return;
    const qty=parseInt(qtyStr,10);
    if (isNaN(qty)||qty<=0) {alert('Invalid #');return;}

    const tgt= prompt('Which line item to start on? (e.g. "q2s4")');
    if (!tgt)return;
    const startIndex= items.findIndex(x=> x.id===tgt);
    if (startIndex<0){alert('No item.');return;}

    const newArr=[...items];
    for (let c=0; c<qty; c++){
      for (let i=startIndex; i<newArr.length; i++){
        const li=newArr[i];
        if (li.type!=='sprint' && li.type!=='year' && li.type!=='quarter') continue;
        const oldE=[...li.events];
        oldE.push({ eventId: ev.id });
        newArr[i]={ ...li, events: oldE };
      }
    }
    setItems(newArr);
  }

  function handleGenerateReport(id){
    setReportTargetId(id);
  }

  function renderReport(){
    if (!reportTargetId) return null;
    const idx= items.findIndex(x=> x.id=== reportTargetId);
    if (idx<0) return null;

    const item= items[idx];
    const sprintIndices= getSprintIndices(idx);

    let totalCost=0, totalPoints=0;
    let breakdownBySpecialty={};
    let usedRoles=[];
    let usedEvents=[];

    sprintIndices.forEach(si=>{
      const sItem= items[si];
      sItem.roles.forEach(rObj=>{
        // find role data
        const rData= roles.find(rr=> rr.id=== rObj.roleId);
        if (!rData) return;
        // cost => overhead/26
        const overhead= rData.salary*rData.overheadMultiplier;
        const cost= overhead/YEAR_SPRINTS;
        totalCost+= cost;

        // points
        const basePts= rData.pointsPerSprint;
        const finalPts= rObj.isRamping? basePts*0.5: basePts;
        totalPoints+= finalPts;

        if (!breakdownBySpecialty[rData.specialty]){
          breakdownBySpecialty[rData.specialty]={ cost:0, points:0};
        }
        breakdownBySpecialty[rData.specialty].cost+= cost;
        breakdownBySpecialty[rData.specialty].points+= finalPts;

        usedRoles.push({ rData, isRamping: rObj.isRamping });
      });
      sItem.events.forEach(eObj=>{
        const eData= events.find(ee=> ee.id=== eObj.eventId);
        if (!eData) return;
        totalPoints+= eData.impactPoints;
        usedEvents.push(eData);
      });
    });

    // distinct
    let distinctRoles=[];
    const seen= new Set();
    usedRoles.forEach(u=>{
      if (!seen.has(u.rData.id)){
        distinctRoles.push(u);
        seen.add(u.rData.id);
      }
    });
    const distinctEvents= Array.from(new Set(usedEvents));

    const totalBoulders= totalPoints/40;
    const costPerPoint= (totalPoints>0)? (totalCost/ totalPoints):0;
    const rampedIds= new Set(usedRoles.filter(u=> u.isRamping).map(u=> u.rData.id));

    return (
      <div className="report">
        <h2>Report for {item.name} ({item.type})</h2>
        <p><strong>Sprints in scope:</strong> {sprintIndices.length}</p>
        <p><strong>Total Cost:</strong> ${Math.round(totalCost).toLocaleString()}</p>
        <p><strong>Total Points:</strong> {Math.round(totalPoints)}</p>
        <p><strong>Boulders (40pts):</strong> {totalBoulders.toFixed(2)}</p>
        <p><strong>Cost per Point:</strong> ${costPerPoint.toFixed(2)}</p>

        <h3>By Specialty</h3>
        {Object.keys(breakdownBySpecialty).map(spec=>{
          const data= breakdownBySpecialty[spec];
          const cperp= (data.points>0)?(data.cost/data.points):0;
          return (
            <div key={spec}>
              <strong>{spec}:</strong> ${cperp.toFixed(2)}/pt
            </div>
          );
        })}

        <h3>Roles in scope</h3>
        <ul>
          {distinctRoles.map(ur=>{
            const star= rampedIds.has(ur.rData.id)? '*':'';
            return (
              <li key={ur.rData.id}>
                {ur.rData.name}{star} ({ur.rData.specialty})
                â€” Salary: ${ur.rData.salary.toLocaleString()}
                {ur.rData.fte? ' (FTE)': ` (Contract up to ${ur.rData.contractSprints} sprints)`}
                , rampUp={ur.rData.rampUpSprints}, pts/sprint={ur.rData.pointsPerSprint}
              </li>
            );
          })}
        </ul>

        <h3>Events in scope</h3>
        <ul>
          {distinctEvents.map(ev=>(
            <li key={ev.id}>{ev.name} (impact={ev.impactPoints})</li>
          ))}
        </ul>
      </div>
    );
  }

  function renderLineItem(li, idx){
    let cssClass='sprint';
    if (li.type==='year') cssClass='year';
    else if (li.type==='quarter') cssClass='quarter';

    const roleIcons= li.roles.map((ro,i2)=>{
      const rData= roles.find(rr=> rr.id=== ro.roleId);
      if (!rData) return null;
      const letter= rData.name.charAt(0).toUpperCase();
      return (
        <span key={'r'+i2}>
          {letter}{ro.isRamping && <span className="ramp">*</span>}
        </span>
      );
    }).filter(Boolean);

    const eventIcons= li.events.map((eo,i2)=>{
      const eData= events.find(ee=> ee.id=== eo.eventId);
      if (!eData) return null;
      const letter=eData.name.charAt(0).toUpperCase();
      return <span key={'e'+i2}>{letter}</span>;
    }).filter(Boolean);

    const combined=[...roleIcons, ...eventIcons];

    return (
      <div
        key={li.id}
        className={`list-item ${cssClass}`}
        onClick={()=> handleGenerateReport(li.id)}
      >
        {li.name}
        {combined.length>0 && (
          <div className="assignments">
            {combined}
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="container">
      <div className="left-panel">
        {items.map((li, idx)=> renderLineItem(li, idx))}
      </div>
      <div className="right-panel">
        <div className="roster">
          <div className="roster-header">
            <h3>Roster</h3>
            <button onClick={handleAddNewItem}>+</button>
          </div>
          <div className="roster-items">
            <h4>Roles</h4>
            {roles.map(r=>(
              <div 
                key={r.id}
                className="roster-item"
                onClick={()=> handleRoleClick(r)}
              >
                {r.name} {r.fte? '(FTE)': '(Contract)'} rampUp={r.rampUpSprints}, pts/sprint={r.pointsPerSprint}
              </div>
            ))}
            <h4>Events</h4>
            {events.map(e=>(
              <div
                key={e.id}
                className="roster-item"
                onClick={()=> handleEventClick(e)}
              >
                {e.name} (impact={e.impactPoints})
              </div>
            ))}
          </div>
        </div>
        <div className="report-section">
          {renderReport()}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<TPSReportsApp />);
</script>
</body>
</html>
