<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TPS Reports - No Drag & Drop, Multi Instances & Cascade</title>

  <!-- React and Babel from CDN (ignore source map warnings). -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      color: #333;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* Left: The vertical list */
    .left-panel {
      padding: 1rem;
      background: #f3f4f6;
      overflow-y: auto;
    }
    .list-item {
      background: #4299e1;
      color: #fff;
      margin: 0.4rem 0;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s;
    }
    .list-item.year {
      background: #2c5282;
    }
    .list-item.quarter {
      background: #2b6cb0;
    }
    .list-item.sprint {
      background: #4299e1;
    }
    .assignments {
      margin-left: 1rem;
      display: flex;
      flex-wrap: wrap;
    }
    .assignments span {
      margin-left: 3px;
      padding: 2px 4px;
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
      font-size: 0.8rem;
    }

    /* Right: Roster + Report */
    .right-panel {
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .roster {
      padding: 1rem;
      background: #fff;
      flex: 0 0 auto;
      border-bottom: 2px solid #ddd;
    }
    .roster-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .roster-header button {
      padding: 0.4rem 0.8rem;
      background: #3182ce;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .roster-items {
      margin-top: 1rem;
    }
    .roster-item {
      background: #edf2f7;
      margin: 0.25rem 0;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
    }
    .roster-item:hover {
      background: #e2e8f0;
    }

    .report-section {
      padding: 1rem;
      flex: 1 1 auto;
      overflow-y: auto;
    }
    .report {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #aaa;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">

    const { useState } = React;

    // Our line items in chronological order:
    // 0: year-2025
    // 1: q1
    // 2..7: q1s1..q1s6
    // 8: q2
    // 9..14: q2s1..q2s6
    // 15: q3
    // 16..21: q3s1..q3s6
    // 22: q4
    // 23..28: q4s1..q4s6
    const initialLineItems = [
      { id: 'year-2025', type: 'year',    name: '2025', roles: [], events: [] },
      { id: 'q1',        type: 'quarter', name: 'Q1',   roles: [], events: [] },
      { id: 'q1s1',      type: 'sprint',  name: 'Q1S1', roles: [], events: [] },
      { id: 'q1s2',      type: 'sprint',  name: 'Q1S2', roles: [], events: [] },
      { id: 'q1s3',      type: 'sprint',  name: 'Q1S3', roles: [], events: [] },
      { id: 'q1s4',      type: 'sprint',  name: 'Q1S4', roles: [], events: [] },
      { id: 'q1s5',      type: 'sprint',  name: 'Q1S5', roles: [], events: [] },
      { id: 'q1s6',      type: 'sprint',  name: 'Q1S6', roles: [], events: [] },

      { id: 'q2',   type: 'quarter', name: 'Q2', roles: [], events: [] },
      { id: 'q2s1', type: 'sprint',  name: 'Q2S1', roles: [], events: [] },
      { id: 'q2s2', type: 'sprint',  name: 'Q2S2', roles: [], events: [] },
      { id: 'q2s3', type: 'sprint',  name: 'Q2S3', roles: [], events: [] },
      { id: 'q2s4', type: 'sprint',  name: 'Q2S4', roles: [], events: [] },
      { id: 'q2s5', type: 'sprint',  name: 'Q2S5', roles: [], events: [] },
      { id: 'q2s6', type: 'sprint',  name: 'Q2S6', roles: [], events: [] },

      { id: 'q3',   type: 'quarter', name: 'Q3', roles: [], events: [] },
      { id: 'q3s1', type: 'sprint',  name: 'Q3S1', roles: [], events: [] },
      { id: 'q3s2', type: 'sprint',  name: 'Q3S2', roles: [], events: [] },
      { id: 'q3s3', type: 'sprint',  name: 'Q3S3', roles: [], events: [] },
      { id: 'q3s4', type: 'sprint',  name: 'Q3S4', roles: [], events: [] },
      { id: 'q3s5', type: 'sprint',  name: 'Q3S5', roles: [], events: [] },
      { id: 'q3s6', type: 'sprint',  name: 'Q3S6', roles: [], events: [] },

      { id: 'q4',   type: 'quarter', name: 'Q4', roles: [], events: [] },
      { id: 'q4s1', type: 'sprint',  name: 'Q4S1', roles: [], events: [] },
      { id: 'q4s2', type: 'sprint',  name: 'Q4S2', roles: [], events: [] },
      { id: 'q4s3', type: 'sprint',  name: 'Q4S3', roles: [], events: [] },
      { id: 'q4s4', type: 'sprint',  name: 'Q4S4', roles: [], events: [] },
      { id: 'q4s5', type: 'sprint',  name: 'Q4S5', roles: [], events: [] },
      { id: 'q4s6', type: 'sprint',  name: 'Q4S6', roles: [], events: [] },
    ];

    function TPSReportsApp() {
      const [lineItems, setLineItems] = useState(initialLineItems);
      const [roles, setRoles] = useState([]);
      const [events, setEvents] = useState([]);

      // For the report
      const [reportTargetId, setReportTargetId] = useState(null);

      // Creates new role or event
      const handleAddNewItem = () => {
        const itemType = prompt('Add "role" or "event"?');
        if (!itemType) return;

        if (itemType.toLowerCase() === 'role') {
          const name = prompt('Role name?');
          const fteOrContract = prompt('FTE? (yes/no)');
          const salary = prompt('Yearly salary?');
          const pointsWeek = prompt('Points delivered per week?');
          const specialty = prompt('Specialty? (e.g. UI, backend, etc.)');

          const newRole = {
            id: 'role-' + Date.now(),
            name: name || 'Untitled Role',
            fte: (fteOrContract?.toLowerCase() === 'yes'),
            overheadMultiplier: (fteOrContract?.toLowerCase() === 'yes') ? 1.17 : 1,
            salary: Number(salary) || 0,
            pointsPerWeek: Number(pointsWeek) || 0,
            specialty: specialty || 'generalist',
          };
          setRoles([...roles, newRole]);

        } else if (itemType.toLowerCase() === 'event') {
          const name = prompt('Event name?');
          const impact = prompt('Impact to shift points? (positive/negative #)');
          const repeat = prompt('Repeat forever? (yes/no)');

          const newEvent = {
            id: 'event-' + Date.now(),
            name: name || 'Untitled Event',
            impactPoints: Number(impact) || 0,
            repeatForever: (repeat?.toLowerCase() === 'yes'),
          };
          setEvents([...events, newEvent]);

        } else {
          alert('Invalid type. Please try again.');
        }
      };

      // Instead of drag & drop, we do "click to assign"
      // We also allow multiple clones of the same role or event
      const handleRoleClick = (role) => {
        // 1. How many clones to add?
        const qtyStr = prompt(`How many of "${role.name}" do you want to add?`, "1");
        if (!qtyStr) return;
        const qty = parseInt(qtyStr, 10);
        if (isNaN(qty) || qty <= 0) return alert('Invalid number');

        // 2. Which line item to add it from?
        const target = prompt(
          `Which line item to assign these ${qty} instance(s) of "${role.name}"?\n(e.g., "q2s3" or "year-2025")\nThey will also propagate to subsequent line items.`
        );
        if (!target) return;

        // 3. Find the index of that line item
        const idx = lineItems.findIndex((li) => li.id === target);
        if (idx < 0) {
          alert('No such line item found.');
          return;
        }

        // 4. Insert the role ID multiple times into that item & all subsequent items
        // We'll treat it like a list of "role IDs" so we can have duplicates
        setLineItems((prev) => {
          const newItems = [...prev];
          for (let i = idx; i < newItems.length; i++) {
            const li = newItems[i];
            const newRoleIDs = [...li.roles];
            // add duplicates
            for (let c = 0; c < qty; c++) {
              newRoleIDs.push(role.id);
            }
            newItems[i] = { ...li, roles: newRoleIDs };
          }
          return newItems;
        });
      };

      const handleEventClick = (ev) => {
        // 1. How many clones to add?
        const qtyStr = prompt(`How many of "${ev.name}" do you want to add?`, "1");
        if (!qtyStr) return;
        const qty = parseInt(qtyStr, 10);
        if (isNaN(qty) || qty <= 0) return alert('Invalid number');

        // 2. Which line item?
        const target = prompt(
          `Which line item to assign these ${qty} instance(s) of "${ev.name}"?\n(e.g., "q2s3" or "year-2025")\nThey will also propagate to subsequent line items.`
        );
        if (!target) return;

        const idx = lineItems.findIndex((li) => li.id === target);
        if (idx < 0) {
          alert('No such line item found.');
          return;
        }

        // 3. Add duplicates to that item & all subsequent items
        setLineItems((prev) => {
          const newItems = [...prev];
          for (let i = idx; i < newItems.length; i++) {
            const li = newItems[i];
            const newEventIDs = [...li.events];
            for (let c = 0; c < qty; c++) {
              newEventIDs.push(ev.id);
            }
            newItems[i] = { ...li, events: newEventIDs };
          }
          return newItems;
        });
      };

      // Clicking a line item => generate a report
      const handleGenerateReport = (lineItemId) => {
        setReportTargetId(lineItemId);
      };

      // The cost/points logic
      function getSprintCountForType(itemType) {
        if (itemType === 'year') return 26;    // 52 weeks => 26 sprints
        if (itemType === 'quarter') return 6;  // 12 weeks => 6 sprints
        if (itemType === 'sprint') return 1;   // 2 weeks => 1 sprint
        return 0;
      }

      const renderReport = () => {
        if (!reportTargetId) return null;
        const target = lineItems.find((li) => li.id === reportTargetId);
        if (!target) return null;

        const sprintCount = getSprintCountForType(target.type);

        // Each line item has an array of role IDs and an array of event IDs
        // We now might have multiple duplicates in roles[], so we must calculate cost/points
        // for each item in roles[] individually (because we allow clones).
        // Example: [ 'role-123', 'role-123' ] => that means we have 2 instances of the same role.

        // Build an array of {roleObj} for each ID
        const usedRoles = target.roles.map((roleId) => {
          return roles.find((r) => r.id === roleId);
        }).filter(Boolean);  // remove any that might not exist

        const usedEvents = target.events.map((eventId) => {
          return events.find((e) => e.id === eventId);
        }).filter(Boolean);

        let totalCost = 0;
        let totalPoints = 0;
        let breakdownBySpecialty = {};

        // For each role instance
        usedRoles.forEach((roleObj) => {
          const overheadSalary = roleObj.salary * roleObj.overheadMultiplier;
          const fraction = sprintCount / 26; // fraction of the year
          const cost = overheadSalary * fraction;
          const points = roleObj.pointsPerWeek * 2 * sprintCount;

          totalCost += cost;
          totalPoints += points;

          if (!breakdownBySpecialty[roleObj.specialty]) {
            breakdownBySpecialty[roleObj.specialty] = { cost: 0, points: 0 };
          }
          breakdownBySpecialty[roleObj.specialty].cost += cost;
          breakdownBySpecialty[roleObj.specialty].points += points;
        });

        usedEvents.forEach((evObj) => {
          totalPoints += evObj.impactPoints * sprintCount;
        });

        const totalBoulders = totalPoints / 40;
        const costPerPoint = totalPoints > 0 ? totalCost / totalPoints : 0;

        return (
          <div className="report">
            <h2>Report for {target.name} ({target.type})</h2>
            <p><strong>Total Cost:</strong> ${Math.round(totalCost).toLocaleString()}</p>
            <p><strong>Total Points:</strong> {Math.round(totalPoints)}</p>
            <p><strong>Boulders (40 pts each):</strong> {totalBoulders.toFixed(2)}</p>
            <p><strong>Cost per Point:</strong> ${costPerPoint.toFixed(2)}</p>

            <h3>By Specialty</h3>
            {Object.keys(breakdownBySpecialty).map((spec) => {
              const data = breakdownBySpecialty[spec];
              const costPerSpecPoint = data.points > 0 ? data.cost / data.points : 0;
              return (
                <div key={spec}>
                  <strong>{spec}:</strong> ${costPerSpecPoint.toFixed(2)} per point
                </div>
              );
            })}

            {/* Roles + duplicates */}
            <h3>Role Instances Assigned</h3>
            <ul>
              {usedRoles.map((r, idx) => (
                <li key={idx}>
                  {r.name} ({r.specialty}) 
                  â€” Salary: ${r.salary.toLocaleString()}
                  {r.fte ? ' (FTE)' : ' (Contract)'}
                </li>
              ))}
            </ul>

            {/* Events + duplicates */}
            <h3>Event Instances Assigned</h3>
            <ul>
              {usedEvents.map((ev, idx) => (
                <li key={idx}>
                  {ev.name} (Impact: {ev.impactPoints}, Repeat: {ev.repeatForever ? 'Yes' : 'No'})
                </li>
              ))}
            </ul>
          </div>
        );
      };

      // Rendering line items on the left
      const renderLineItem = (item) => {
        // We might have duplicates in item.roles, so let's just show the first letter for each
        // e.g. if we have 2 identical role IDs, we show letter "F" "F" if the name starts with "F"
        const roleLetters = item.roles.map((rid, idx) => {
          const found = roles.find((r) => r.id === rid);
          const letter = found ? found.name.charAt(0).toUpperCase() : '?';
          return <span key={`${rid}-${idx}`}>{letter}</span>;
        });
        const eventLetters = item.events.map((eid, idx) => {
          const found = events.find((e) => e.id === eid);
          const letter = found ? found.name.charAt(0).toUpperCase() : '?';
          return <span key={`${eid}-${idx}`}>{letter}</span>;
        });
        const combinedAssignments = [...roleLetters, ...eventLetters];

        // For CSS
        const typeClass = item.type === 'year'
          ? 'year'
          : item.type === 'quarter'
          ? 'quarter'
          : 'sprint';

        return (
          <div
            key={item.id}
            className={`list-item ${typeClass}`}
            onClick={() => handleGenerateReport(item.id)}
          >
            <span>{item.name}</span>
            {combinedAssignments.length > 0 && (
              <div className="assignments">
                {combinedAssignments}
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="container">
          {/* LEFT PANEL: LIST ITEMS */}
          <div className="left-panel">
            {lineItems.map(renderLineItem)}
          </div>

          {/* RIGHT PANEL: ROSTER + REPORT */}
          <div className="right-panel">
            <div className="roster">
              <div className="roster-header">
                <h3>Roster</h3>
                <button onClick={handleAddNewItem}>+</button>
              </div>
              <div className="roster-items">
                <h4>Roles</h4>
                {roles.map((role) => (
                  <div
                    key={role.id}
                    className="roster-item"
                    onClick={() => handleRoleClick(role)}
                  >
                    {role.name} ({role.specialty})
                  </div>
                ))}

                <h4>Events</h4>
                {events.map((ev) => (
                  <div
                    key={ev.id}
                    className="roster-item"
                    onClick={() => handleEventClick(ev)}
                  >
                    {ev.name} (Impact: {ev.impactPoints})
                  </div>
                ))}
              </div>
            </div>
            <div className="report-section">
              {renderReport()}
            </div>
          </div>
        </div>
      );
    }

    // Render app
    const rootEl = document.getElementById('root');
    ReactDOM.createRoot(rootEl).render(<TPSReportsApp />);
  </script>
</body>
</html>
